<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cart — Parts Search</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="page-shell">
    <div class="orb orb--one" aria-hidden="true"></div>
    <div class="orb orb--two" aria-hidden="true"></div>
    <header class="app-header">
      <div class="brand">
        <img src="assets/RA Logo.jpg" alt="Rochester Appliance" class="brand-mark brand-mark--logo">
        <div class="brand-copy">
          <span class="brand-label">Rochester Appliance</span>
          <span class="brand-subtitle">Parts Search</span>
        </div>
      </div>
      <div class="header-actions">
        <div class="header-contact">
          <span class="contact-label">Call</span>
          <a href="tel:5852729933" class="contact-link">585-272-9933</a>
        </div>
        <a href="index.html" class="cart-chip" aria-label="Return">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M10 19l-7-7 7-7v4h8v6h-8v4z" />
          </svg>
        </a>
      </div>
    </header>
    <main class="main-shell" style="margin-top:48px;">
      <section class="workspace">
        <div class="panel" style="padding: clamp(24px, 4vw, 32px); display:flex; flex-direction:column; gap:24px;">
          <div style="display:flex; flex-direction:column; gap:12px;">
            <span class="hero-eyebrow" style="align-self:flex-start;">Stripe ready checkout</span>
            <h1 style="margin:0; font-family: 'Space Grotesk', 'Inter', sans-serif; font-size: clamp(28px, 5vw, 40px);">
              Session Cart</h1>
            <p class="hero-meta" style="margin:0;">Adjust quantities, remove items, or head back to explore more
              diagrams. Checkout flows stay synced with your selections.</p>
          </div>
          <div id="cart-page"></div>
          <a href="index.html" class="panel-link" style="align-self:flex-start;">&#8592; Continue discovery</a>
        </div>
      </section>
    </main>
  </div>
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    (function () {
      const params = new URLSearchParams(location.search);
      const API_BASE = params.get('api') || (location.hostname.includes('localhost') || location.protocol === 'file:' ? 'http://localhost:3001' : 'https://rocparts-api.onrender.com');
      let cart = [];
      try { cart = JSON.parse(localStorage.getItem('vandv_cart') || '[]') || []; } catch (e) { cart = []; }
      const el = document.getElementById('cart-page');
      function render() {
        if (!cart.length) { el.innerHTML = '<div class="card"><div style="display:flex; flex-direction:column; gap:12px;"><strong>Your cart is empty.</strong><span class="hero-meta">Add parts from diagram results or the part details drawer to see them here.</span></div></div>'; return; }
        const subtotal = cart.reduce((s, i) => s + (Number(i.price || 0) * (i.qty || 1)), 0);
        el.innerHTML = `
          <div class="card">
            ${cart.map((i, idx) => `
              <div class="cart-item">
                <div><strong>${escapeHtml(i.partNumber)}</strong><div class="muted" style="font-size:12px;">${escapeHtml(i.partDescription || '')}</div></div>
                <div>$${Number(i.price || 0).toFixed(2)}</div>
                <div>
                  <button class="btn-link" data-role="dec" data-idx="${idx}">−</button>
                  <span>${i.qty || 1}</span>
                  <button class="btn-link" data-role="inc" data-idx="${idx}">+</button>
                </div>
                <div><button class="btn-link" data-role="rm" data-idx="${idx}">Remove</button></div>
              </div>
            `).join('')}
            <div class="cart-actions">
              <div class="cart-summary"><strong>Subtotal:</strong> $${subtotal.toFixed(2)}</div>
              <button class="btn-secondary" id="clear">Clear Cart</button>
              <button class="btn-primary" id="checkout">Checkout</button>
            </div>
          </div>`;
        bind();
      }
      function bind() {
        el.querySelectorAll('[data-role="inc"]').forEach(b => b.onclick = () => { const i = +b.dataset.idx; cart[i].qty = (cart[i].qty || 1) + 1; save(); });
        el.querySelectorAll('[data-role="dec"]').forEach(b => b.onclick = () => { const i = +b.dataset.idx; cart[i].qty = Math.max(1, (cart[i].qty || 1) - 1); save(); });
        el.querySelectorAll('[data-role="rm"]').forEach(b => b.onclick = () => { const i = +b.dataset.idx; cart.splice(i, 1); save(); });
        const clear = document.getElementById('clear'); if (clear) clear.onclick = () => { cart = []; save(); };
        const checkout = document.getElementById('checkout'); if (checkout) checkout.onclick = onCheckout;
      }
      function save() { localStorage.setItem('vandv_cart', JSON.stringify(cart)); render(); }
      async function onCheckout() {
        try {
          if (!window.Stripe) { alert('Stripe.js not loaded'); return; }
          const cfgRes = await fetch(`${API_BASE}/api/stripe-config`);
          const cfg = await cfgRes.json();
          const stripe = window.Stripe(cfg.publishableKey);
          const payload = { items: cart.map(i => ({ partNumber: i.partNumber, partDescription: i.partDescription, price: i.price, qty: i.qty })) };
          const res = await fetch(`${API_BASE}/api/checkout/session`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          const data = await res.json(); if (!res.ok) throw new Error(data && data.details || 'Failed to create session');
          const { error } = await stripe.redirectToCheckout({ sessionId: data.id }); if (error) alert(error.message);
        } catch (e) { console.error(e); alert('Checkout failed: ' + (e.message || 'Unknown error')); }
      }
      function escapeHtml(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
      render();
    })();
  </script>
</body>

</html>